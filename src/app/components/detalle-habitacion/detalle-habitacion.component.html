<!-- HU07: Detalle de HabitaciÃ³n -->
<!-- Barra de navegaciÃ³n solo cuando NO estamos en el dashboard -->
<div class="navigation-header" *ngIf="!isDashboardView()">
  <button (click)="volverAResultados()" class="btn-volver-nav">
    â† Volver a BÃºsqueda
  </button>
  <button (click)="irAInicio()" class="btn-home-nav">
    ğŸ  Inicio
  </button>
</div>

<div class="detalle-container">
  
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando detalle de la habitaciÃ³n...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-icon">âš ï¸</div>
    <h2>Error al cargar</h2>
    <p>{{ error }}</p>
    <button (click)="volverAResultados()" class="btn-volver">
      â† Volver a resultados
    </button>
  </div>

  <!-- Detalle completo -->
  <div *ngIf="habitacion && !loading" class="detalle-content">
    
    <!-- HU07 CA4: BotÃ³n Volver conservando filtros - solo cuando estamos en dashboard -->
    <button *ngIf="!isDashboardView()" (click)="volverAResultados()" class="btn-volver-arriba">
      â† Volver a resultados
    </button>

    <!-- HU07 CA2: Advertencia de disponibilidad cambiada -->
    <div *ngIf="disponibilidadCambiada" class="alerta-disponibilidad">
      <span class="icono-alerta">âš ï¸</span>
      <div class="mensaje-alerta">
        <strong>Disponibilidad actualizada</strong>
        <p>{{ mensajeDisponibilidad }}</p>
      </div>
      <button (click)="volverAResultados()" class="btn-buscar-otra">
        Buscar otra habitaciÃ³n
      </button>
    </div>

    <!-- HU07 CA1: GalerÃ­a de fotos -->
    <section class="galeria-principal">
      <div class="foto-principal" (click)="abrirGaleria(0)">
        <img [src]="fotosDisponibles[0]" [alt]="'Foto principal ' + habitacion.tipo">
        <div class="overlay-galeria">
          <span class="icono-expandir">ğŸ”</span>
          <span>Ver galerÃ­a ({{ fotosDisponibles.length }} fotos)</span>
        </div>
      </div>
      <div class="fotos-secundarias">
        <div *ngFor="let foto of fotosDisponibles.slice(1, 5); let i = index" 
             class="foto-secundaria"
             (click)="abrirGaleria(i + 1)">
          <img [src]="foto" [alt]="'Foto ' + (i + 2)">
          <div *ngIf="i === 3 && fotosDisponibles.length > 5" class="overlay-mas">
            +{{ fotosDisponibles.length - 5 }}
          </div>
        </div>
      </div>
    </section>

    <!-- HU07 CA1: InformaciÃ³n principal -->
    <div class="info-principal">
      
      <!-- Columna izquierda: Detalles -->
      <div class="columna-detalles">
        
        <!-- TÃ­tulo y capacidad -->
        <div class="header-habitacion">
          <h1>{{ habitacion.tipo }} - HabitaciÃ³n {{ habitacion.numero }}</h1>
          <div class="capacidad-badge">
            <span class="icono">ğŸ‘¥</span>
            <span>Hasta {{ habitacion.capacidad }} huÃ©spedes</span>
          </div>
        </div>

        <!-- Hotel info -->
        <div class="info-hotel">
          <h3>ğŸ¨ {{ habitacion.hotel.nombre }}</h3>
          <p class="ubicacion">ğŸ“ {{ habitacion.hotel.direccion }}, {{ habitacion.hotel.ciudad }}</p>
          <div class="contacto">
            <span>ğŸ“ {{ habitacion.hotel.telefono }}</span>
            <span *ngIf="habitacion.hotel.email">âœ‰ï¸ {{ habitacion.hotel.email }}</span>
          </div>
          <div *ngIf="habitacion.hotel.calificacion > 0" class="calificacion">
            <span class="estrellas">â­</span>
            <span>{{ habitacion.hotel.calificacion }} / 5</span>
          </div>
        </div>

        <!-- DescripciÃ³n -->
        <div class="descripcion">
          <h2>ğŸ“ DescripciÃ³n</h2>
          <p>{{ habitacion.descripcion }}</p>
        </div>

        <!-- Servicios -->
        <div class="servicios-detalle">
          <h2>âœ¨ Servicios Incluidos</h2>
          <div class="servicios-grid">
            <div *ngFor="let servicio of habitacion.servicios" class="servicio-item">
              <span class="check-icon">âœ“</span>
              <span>{{ servicio }}</span>
            </div>
          </div>
          <div *ngIf="!habitacion.servicios || habitacion.servicios.length === 0" class="sin-servicios">
            <p>No hay servicios especificados</p>
          </div>
        </div>

        <!-- PolÃ­ticas del hotel -->
        <div class="politicas">
          <h2>ğŸ“‹ PolÃ­ticas del Hotel</h2>
          <div class="politicas-grid">
            <div class="politica-item">
              <strong>ğŸ•’ Check-in:</strong>
              <span>{{ habitacion.hotel.politicas.checkIn }}</span>
            </div>
            <div class="politica-item">
              <strong>ğŸ• Check-out:</strong>
              <span>{{ habitacion.hotel.politicas.checkOut }}</span>
            </div>
            <div class="politica-item">
              <strong>ğŸ”„ CancelaciÃ³n:</strong>
              <span>{{ habitacion.hotel.politicas.cancelacion }}</span>
            </div>
            <div class="politica-item">
              <strong>ğŸ• Mascotas:</strong>
              <span>{{ habitacion.hotel.politicas.mascotas ? 'Permitidas' : 'No permitidas' }}</span>
            </div>
            <div class="politica-item">
              <strong>ğŸš­ Fumar:</strong>
              <span>{{ habitacion.hotel.politicas.fumadores ? 'Permitido' : 'No permitido' }}</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Columna derecha: Tarifa y reserva -->
      <div class="columna-tarifa">
        
        <!-- HU07 CA3: Tarifa clara con desglose -->
        <div class="card-tarifa">
          <div class="precio-principal">
            <span class="desde">Desde</span>
            <span class="precio">{{ formatearPrecio(habitacion.precio) }}</span>
            <span class="por-noche">por noche</span>
          </div>

          <!-- Si hay fechas seleccionadas, mostrar desglose -->
          <div *ngIf="fechaInicio && fechaFin && !cargandoTarifa" class="desglose-container">
            <div class="fechas-seleccionadas">
              <div class="fecha-item">
                <span class="label">Check-in</span>
                <strong>{{ fechaInicio | date: 'dd/MM/yyyy' }}</strong>
              </div>
              <span class="separador">â†’</span>
              <div class="fecha-item">
                <span class="label">Check-out</span>
                <strong>{{ fechaFin | date: 'dd/MM/yyyy' }}</strong>
              </div>
            </div>

            <div *ngIf="tarifa" class="desglose">
              <h3>ğŸ’° Desglose de Precio</h3>
              
              <div class="linea-desglose">
                <span>{{ formatearPrecio(tarifa.precioPorNoche) }} Ã— {{ noches }} noche<span *ngIf="noches > 1">s</span></span>
                <strong>{{ formatearPrecio(tarifa.subtotal) }}</strong>
              </div>

              <div class="linea-desglose impuestos">
                <span>{{ tarifa.impuestos.concepto }}</span>
                <strong>{{ formatearPrecio(tarifa.impuestos.monto) }}</strong>
              </div>

              <div class="separador-desglose"></div>

              <div class="linea-total">
                <span>Total</span>
                <strong class="precio-total">{{ formatearPrecio(tarifa.total) }}</strong>
              </div>
            </div>
          </div>

          <!-- Loading tarifa -->
          <div *ngIf="cargandoTarifa" class="loading-tarifa">
            <div class="spinner-pequeno"></div>
            <span>Calculando precio...</span>
          </div>

          <!-- Sin fechas seleccionadas -->
          <div *ngIf="!fechaInicio || !fechaFin" class="sin-fechas">
            <p>ğŸ’¡ Selecciona tus fechas de estadÃ­a en la bÃºsqueda para ver el precio total</p>
          </div>

          <!-- BotÃ³n de reserva -->
          <button 
            *ngIf="habitacion.disponible && !disponibilidadCambiada"
            (click)="irAReserva()" 
            class="btn-reservar"
            [disabled]="!fechaInicio || !fechaFin">
            {{ (!fechaInicio || !fechaFin) ? 'Selecciona fechas para reservar' : 'Reservar ahora' }}
          </button>

          <!-- No disponible -->
          <div *ngIf="!habitacion.disponible || disponibilidadCambiada" class="no-disponible">
            <span class="icono">âš ï¸</span>
            <span>No disponible</span>
          </div>
        </div>

        <!-- Info adicional -->
        <div class="info-adicional">
          <p class="tip">ğŸ’¡ <strong>Tip:</strong> El precio puede variar segÃºn temporada y disponibilidad</p>
          <p class="garantia">âœ“ Mejor precio garantizado</p>
          <p class="cancelacion-gratis">âœ“ {{ habitacion.hotel.politicas.cancelacion }}</p>
        </div>

      </div>

    </div>

  </div>

</div>

<!-- Modal de galerÃ­a fullscreen -->
<div *ngIf="mostrarGaleria" class="modal-galeria" (click)="cerrarGaleria()">
  <button class="btn-cerrar-modal" (click)="cerrarGaleria()">âœ•</button>
  <button class="btn-nav btn-anterior" (click)="fotoAnterior(); $event.stopPropagation()">â€¹</button>
  <button class="btn-nav btn-siguiente" (click)="fotoSiguiente(); $event.stopPropagation()">â€º</button>
  
  <div class="galeria-content" (click)="$event.stopPropagation()">
    <img [src]="fotosDisponibles[fotoActual]" [alt]="'Foto ' + (fotoActual + 1)">
    <div class="contador-fotos">{{ fotoActual + 1 }} / {{ fotosDisponibles.length }}</div>
  </div>
</div>
