<div class="navigation-header">
  <button (click)="irAInicio()" class="btn-home-nav">
    ğŸ  Inicio
  </button>
  <button (click)="irABuscar()" class="btn-search-nav">
    ğŸ” Buscar Habitaciones
  </button>
</div>

<div class="mis-reservas-container">

  <!-- Header -->
  <div class="header">
    <h1>ğŸ“‹ Mis Reservas</h1>
    <button class="btn-recargar" (click)="recargar()" [disabled]="cargando || cargandoPaquetes">
      ğŸ”„ {{ (cargando || cargandoPaquetes) ? 'Cargando...' : 'Actualizar' }}
    </button>
  </div>

  <!-- PestaÃ±as de tipo de reserva -->
  <div class="tabs-section">
    <button 
      class="tab-btn" 
      [class.activo]="vistaActual === 'habitaciones'"
      (click)="cambiarVista('habitaciones')">
      ğŸ¨ Habitaciones ({{ reservas.length }})
    </button>
    <button 
      class="tab-btn" 
      [class.activo]="vistaActual === 'paquetes'"
      (click)="cambiarVista('paquetes')">
      ğŸ“¦ Paquetes Corporativos ({{ reservasPaquetes.length }})
    </button>
  </div>

  <!-- Filtros y BÃºsqueda -->
  <div class="filtros-section">
    <!-- Filtros por Estado -->
    <div class="filtros-estado">
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'todas'"
        (click)="cambiarFiltro('todas')">
        Todas ({{ vistaActual === 'habitaciones' ? contarPorEstado('todas') : contarPaquetesPorEstado('todas') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'confirmada'"
        (click)="cambiarFiltro('confirmada')">
        âœ… Confirmadas ({{ vistaActual === 'habitaciones' ? contarPorEstado('confirmada') : contarPaquetesPorEstado('confirmada') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'pendiente'"
        (click)="cambiarFiltro('pendiente')">
        â³ Pendientes ({{ vistaActual === 'habitaciones' ? contarPorEstado('pendiente') : contarPaquetesPorEstado('pendiente') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'cancelada'"
        (click)="cambiarFiltro('cancelada')">
        âŒ Canceladas ({{ vistaActual === 'habitaciones' ? contarPorEstado('cancelada') : contarPaquetesPorEstado('cancelada') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'completada'"
        (click)="cambiarFiltro('completada')">
        âœ”ï¸ Completadas ({{ vistaActual === 'habitaciones' ? contarPorEstado('completada') : contarPaquetesPorEstado('completada') }})
      </button>
    </div>

    <!-- Barra de BÃºsqueda -->
    <div class="busqueda">
      <input 
        type="text" 
        class="input-busqueda" 
        placeholder="Buscar por cÃ³digo, hotel o tipo de habitaciÃ³n..."
        [(ngModel)]="busquedaCodigo"
        (input)="buscar()">
      <button 
        class="btn-limpiar" 
        *ngIf="busquedaCodigo"
        (click)="limpiarBusqueda()">
        âœ•
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando" class="loading">
    <div class="spinner"></div>
    <p>Cargando reservas...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !cargando" class="error-message">
    <p>âš ï¸ {{ error }}</p>
    <button class="btn-reintentar" (click)="recargar()">Reintentar</button>
  </div>

  <!-- Lista VacÃ­a - Habitaciones -->
  <div *ngIf="vistaActual === 'habitaciones' && !cargando && !error && reservasFiltradas.length === 0" class="lista-vacia">
    <div class="icono-vacio">ğŸ“­</div>
    <h3>No hay reservas de habitaciones</h3>
    <p *ngIf="busquedaCodigo">No se encontraron resultados para "{{ busquedaCodigo }}"</p>
    <p *ngIf="!busquedaCodigo && estadoFiltro !== 'todas'">
      No tienes reservas de habitaciones en estado "{{ estadoFiltro }}"
    </p>
    <p *ngIf="!busquedaCodigo && estadoFiltro === 'todas'">
      AÃºn no has realizado ninguna reserva de habitaciÃ³n.
    </p>
    <button class="btn-buscar-habitaciones" (click)="irABuscar()">
      ğŸ” Buscar Habitaciones
    </button>
  </div>

  <!-- Lista VacÃ­a - Paquetes -->
  <div *ngIf="vistaActual === 'paquetes' && !cargandoPaquetes && !error && reservasPaquetesFiltradas.length === 0" class="lista-vacia">
    <div class="icono-vacio">ğŸ“¦</div>
    <h3>No hay reservas de paquetes</h3>
    <p *ngIf="busquedaCodigo">No se encontraron resultados para "{{ busquedaCodigo }}"</p>
    <p *ngIf="!busquedaCodigo && estadoFiltro !== 'todas'">
      No tienes reservas de paquetes en estado "{{ estadoFiltro }}"
    </p>
    <p *ngIf="!busquedaCodigo && estadoFiltro === 'todas'">
      AÃºn no has realizado ninguna reserva de paquete corporativo.
    </p>
    <button class="btn-buscar-habitaciones" (click)="router.navigate(['/ver-paquetes'])">
      ï¿½ Ver Paquetes Disponibles
    </button>
  </div>

  <!-- Lista de Reservas de Habitaciones -->
  <div *ngIf="vistaActual === 'habitaciones' && !cargando && !error && reservasFiltradas.length > 0" class="reservas-grid">
    <div *ngFor="let reserva of reservasFiltradas" class="reserva-card">
      <!-- Header de Card -->
      <div class="card-header">
        <div class="codigo-estado">
          <span class="codigo">{{ reserva.codigoReserva }}</span>
          <span class="estado-badge" [ngClass]="getEstadoClase(reserva.estado)">
            {{ getEstadoIcono(reserva.estado) }} {{ reserva.estado }}
          </span>
        </div>
        <div class="tiempo-restante" *ngIf="reserva.estado === 'confirmada' && reserva.horasHastaCheckIn && reserva.horasHastaCheckIn > 0">
          â° {{ getTiempoRestante(reserva) }}
        </div>
      </div>

      <!-- InformaciÃ³n Principal -->
      <div class="card-body">
        <!-- Hotel y HabitaciÃ³n -->
        <div class="info-principal">
          <h3 class="hotel-nombre">ğŸ¨ {{ reserva.hotel.nombre }}</h3>
          <p class="hotel-ubicacion">ğŸ“ {{ reserva.hotel.ciudad }}, {{ reserva.hotel.departamento }}</p>
          <p class="habitacion-tipo">ğŸ›ï¸ {{ reserva.habitacion.tipo }} - HabitaciÃ³n {{ reserva.habitacion.numero }}</p>
        </div>

        <!-- Fechas -->
        <div class="info-fechas">
          <div class="fecha-item">
            <span class="fecha-label">Check-in:</span>
            <span class="fecha-valor">{{ formatearFecha(reserva.fechaInicio) }}</span>
          </div>
          <div class="fecha-item">
            <span class="fecha-label">Check-out:</span>
            <span class="fecha-valor">{{ formatearFecha(reserva.fechaFin) }}</span>
          </div>
          <div class="fecha-item">
            <span class="fecha-label">Noches:</span>
            <span class="fecha-valor">{{ reserva.noches }}</span>
          </div>
        </div>

        <!-- Tarifa -->
        <div class="info-tarifa">
          <div class="tarifa-total">
            <span class="tarifa-label">Total:</span>
            <span class="tarifa-valor">{{ formatearPrecio(reserva.tarifa.total) }}</span>
          </div>
        </div>

        <!-- Alertas de AcciÃ³n -->
        <div class="alertas" *ngIf="reserva.estado === 'confirmada'">
          <!-- Alerta: No puede modificar (< 24h) -->
          <div class="alerta alerta-warning" *ngIf="!reserva.puedeModificar && reserva.horasHastaCheckIn && reserva.horasHastaCheckIn < 24 && reserva.horasHastaCheckIn > 0">
            âš ï¸ No puedes modificar esta reserva (faltan menos de 24h para el check-in)
          </div>

          <!-- Alerta: Puede modificar -->
          <div class="alerta alerta-info" *ngIf="reserva.puedeModificar">
            â„¹ï¸ Puedes modificar las fechas hasta 24h antes del check-in
          </div>
        </div>
      </div>

      <!-- Footer de Card: Botones de AcciÃ³n -->
      <div class="card-footer">
        <!-- HU11: BotÃ³n Descargar Recibo -->
        <button 
          class="btn btn-recibo" 
          *ngIf="reserva.estado === 'confirmada' || reserva.estado === 'completada'"
          (click)="verRecibo(reserva)"
          title="Ver y descargar recibo de pago">
          ğŸ“„ Ver Recibo
        </button>

        <button class="btn btn-secondary" (click)="verDetalle(reserva)">
          ğŸ‘ï¸ Ver Detalle
        </button>

        <!-- HU09: BotÃ³n Modificar Fechas -->
        <button 
          class="btn btn-primary" 
          *ngIf="reserva.estado === 'confirmada'"
          [disabled]="!reserva.puedeModificar"
          [title]="!reserva.puedeModificar ? 'No se puede modificar esta reserva' : 'Modificar fechas de la reserva'"
          (click)="modificarFechas(reserva)">
          ğŸ“… Modificar
        </button>

        <!-- HU10: BotÃ³n Cancelar -->
        <button 
          class="btn btn-danger" 
          *ngIf="reserva.estado === 'confirmada'"
          [disabled]="!reserva.puedeCancelar"
          [title]="!reserva.puedeCancelar ? 'No se puede cancelar esta reserva' : 'Cancelar reserva'"
          (click)="abrirModalCancelar(reserva)">
          âŒ Cancelar
        </button>

        <!-- Estado no permite acciones -->
        <span class="sin-acciones" *ngIf="reserva.estado !== 'confirmada' && reserva.estado !== 'completada'">
          {{ reserva.estado === 'cancelada' ? 'Reserva cancelada' : 'Reserva en proceso' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Lista de Reservas de Paquetes -->
  <div *ngIf="vistaActual === 'paquetes' && !cargandoPaquetes && !error && reservasPaquetesFiltradas.length > 0" class="reservas-grid">
    <div *ngFor="let reserva of reservasPaquetesFiltradas" class="reserva-card paquete-card">
      <!-- Header de Card -->
      <div class="card-header">
        <div class="codigo-estado">
          <span class="codigo">{{ reserva.numeroReserva }}</span>
          <span class="estado-badge" [ngClass]="getEstadoClase(reserva.estado)">
            {{ getEstadoIcono(reserva.estado) }} {{ reserva.estado }}
          </span>
        </div>
        <div class="tipo-evento">
          ğŸ“‹ {{ reserva.tipoEvento }}
        </div>
      </div>

      <!-- InformaciÃ³n Principal -->
      <div class="card-body">
        <!-- Evento y Empresa -->
        <div class="info-principal">
          <h3 class="evento-nombre">ğŸ¯ {{ reserva.nombreEvento }}</h3>
          <p class="empresa-nombre">ğŸ¢ {{ reserva.datosEmpresa?.razonSocial }}</p>
          <p class="hotel-ubicacion">ğŸ“ Hotel: {{ reserva.paquete?.hotel?.nombre }} - {{ reserva.paquete?.hotel?.ciudad }}</p>
        </div>

        <!-- Fechas -->
        <div class="info-fechas">
          <div class="fecha-item">
            <span class="fecha-label">ğŸ“… Fecha del Evento:</span>
            <span class="fecha-valor">{{ formatearFecha(reserva.fechaInicio) }}</span>
          </div>
          <div class="fecha-item">
            <span class="fecha-label">ğŸ‘¥ Asistentes:</span>
            <span class="fecha-valor">{{ reserva.numeroAsistentes }} personas</span>
          </div>
        </div>

        <!-- InformaciÃ³n Adicional -->
        <div class="info-adicional">
          <div class="info-item">
            <span class="info-label">ğŸ“§ Email:</span>
            <span class="info-valor">{{ reserva.datosEmpresa?.email }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">ğŸ“ TelÃ©fono:</span>
            <span class="info-valor">{{ reserva.datosEmpresa?.telefono }}</span>
          </div>
        </div>

        <!-- Precio Total -->
        <div class="precio-total" *ngIf="reserva.precios?.total">
          <span class="precio-label">Total:</span>
          <span class="precio-valor">{{ formatearPrecio(reserva.precios.total) }}</span>
        </div>
      </div>

      <!-- Acciones -->
      <div class="card-actions">
        <button 
          class="btn btn-outline-primary btn-sm"
          [title]="'Ver detalles completos de la reserva ' + reserva.numeroReserva">
          ğŸ‘ï¸ Ver Detalles
        </button>
        
        <button 
          *ngIf="reserva.estado === 'confirmada'"
          class="btn btn-outline-warning btn-sm"
          [title]="'Modificar reserva ' + reserva.numeroReserva">
          âœï¸ Modificar
        </button>
        
        <button 
          *ngIf="reserva.estado === 'confirmada'"
          class="btn btn-outline-danger btn-sm"
          [title]="'Cancelar reserva ' + reserva.numeroReserva">
          âŒ Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de CancelaciÃ³n -->
  <div class="modal-overlay" *ngIf="mostrarModalCancelar" (click)="cerrarModalCancelar()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸš« Cancelar Reserva</h2>
        <button class="btn-cerrar-modal" (click)="cerrarModalCancelar()">âœ•</button>
      </div>

      <div class="modal-body">
        <!-- HU10: Loading mientras verifica polÃ­ticas -->
        <div *ngIf="verificandoPoliticas" class="modal-loading">
          <div class="spinner-small"></div>
          <p>Verificando polÃ­ticas de cancelaciÃ³n...</p>
        </div>

        <!-- Contenido del modal cuando ya se verificaron polÃ­ticas -->
        <div *ngIf="!verificandoPoliticas && politicaCancelacion">
          <p class="modal-advertencia">
            âš ï¸ EstÃ¡s a punto de cancelar la siguiente reserva:
          </p>

          <div class="reserva-resumen" *ngIf="reservaACancelar">
            <p><strong>CÃ³digo:</strong> {{ reservaACancelar.codigoReserva }}</p>
            <p><strong>Hotel:</strong> {{ reservaACancelar.hotel.nombre }}</p>
            <p><strong>HabitaciÃ³n:</strong> {{ reservaACancelar.habitacion.tipo }}</p>
            <p><strong>Fechas:</strong> {{ formatearFecha(reservaACancelar.fechaInicio) }} - {{ formatearFecha(reservaACancelar.fechaFin) }}</p>
            <p><strong>Total pagado:</strong> {{ formatearPrecio(reservaACancelar.tarifa.total) }}</p>
          </div>

          <!-- HU10 CA1 + CA2: InformaciÃ³n de PenalizaciÃ³n -->
          <div class="politica-cancelacion">
            <h4>ğŸ“‹ PolÃ­tica de CancelaciÃ³n</h4>
            
            <!-- CA1: CancelaciÃ³n Gratuita -->
            <div *ngIf="politicaCancelacion.dentroVentanaGratuita" class="alerta alerta-success">
              <strong>âœ… CancelaciÃ³n Gratuita</strong>
              <p>{{ politicaCancelacion.mensaje }}</p>
              <div class="detalle-reembolso">
                <span>Reembolso completo:</span>
                <strong class="monto-reembolso">{{ formatearPrecio(politicaCancelacion.montoReembolso) }}</strong>
              </div>
            </div>

            <!-- CA2: Con PenalizaciÃ³n -->
            <div *ngIf="!politicaCancelacion.dentroVentanaGratuita" class="alerta alerta-warning-penalizacion">
              <strong>âš ï¸ PenalizaciÃ³n Aplicable</strong>
              <p>{{ politicaCancelacion.mensaje }}</p>
              
              <div class="desglose-penalizacion">
                <div class="linea-desglose">
                  <span>Total pagado:</span>
                  <span>{{ formatearPrecio(reservaACancelar?.tarifa?.total || 0) }}</span>
                </div>
                <div class="linea-desglose penalizacion">
                  <span>PenalizaciÃ³n ({{ politicaCancelacion.porcentajePenalizacion }}%):</span>
                  <span class="monto-negativo">-{{ formatearPrecio(politicaCancelacion.montoPenalizacion) }}</span>
                </div>
                <div class="linea-desglose total-reembolso">
                  <span><strong>Reembolso:</strong></span>
                  <strong class="monto-reembolso">{{ formatearPrecio(politicaCancelacion.montoReembolso) }}</strong>
                </div>
              </div>

              <!-- CA2: Checkbox de confirmaciÃ³n de penalizaciÃ³n -->
              <div class="confirmacion-penalizacion">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    [(ngModel)]="aceptaPenalizacion"
                    [disabled]="cancelando">
                  <span>Acepto la penalizaciÃ³n del {{ politicaCancelacion.porcentajePenalizacion }}% y entiendo que recibirÃ© {{ formatearPrecio(politicaCancelacion.montoReembolso) }} de reembolso.</span>
                </label>
              </div>
            </div>

            <!-- InformaciÃ³n adicional -->
            <div class="info-tiempo">
              <p><strong>â° Tiempo hasta check-in:</strong> {{ politicaCancelacion.horasHastaCheckIn }} horas ({{ politicaCancelacion.diasHastaCheckIn }} dÃ­as)</p>
            </div>

            <div class="detalles-politica">
              <p class="titulo-detalles"><strong>Ventanas de cancelaciÃ³n:</strong></p>
              <ul>
                <li>{{ politicaCancelacion.detalles.ventanaGratuita }}: Sin penalizaciÃ³n</li>
                <li>{{ politicaCancelacion.detalles.penalizacion50 }}: 50% de penalizaciÃ³n</li>
                <li>{{ politicaCancelacion.detalles.penalizacion100 }}: 100% de penalizaciÃ³n</li>
              </ul>
            </div>
          </div>

          <!-- Motivo de cancelaciÃ³n -->
          <div class="form-group">
            <label for="motivoCancelacion">Motivo de la cancelaciÃ³n: *</label>
            <textarea 
              id="motivoCancelacion"
              class="textarea-motivo"
              [(ngModel)]="motivoCancelacion"
              placeholder="Por favor, indica el motivo de la cancelaciÃ³n..."
              rows="3"
              [disabled]="cancelando"></textarea>
          </div>

          <!-- HU10 CA4: Nota sobre notificaciÃ³n -->
          <p class="modal-nota">
            â„¹ï¸ RecibirÃ¡s un correo electrÃ³nico de confirmaciÃ³n con los detalles de la cancelaciÃ³n.
          </p>
        </div>
      </div>

      <div class="modal-footer" *ngIf="!verificandoPoliticas">
        <button 
          class="btn btn-secondary" 
          (click)="cerrarModalCancelar()"
          [disabled]="cancelando">
          Volver
        </button>
        <button 
          class="btn btn-danger" 
          (click)="confirmarCancelacion()"
          [disabled]="cancelando || !motivoCancelacion.trim() || (politicaCancelacion && politicaCancelacion.montoPenalizacion > 0 && !aceptaPenalizacion)">
          {{ cancelando ? 'Cancelando...' : 'Confirmar CancelaciÃ³n' }}
        </button>
      </div>
    </div>
  </div>
</div>
