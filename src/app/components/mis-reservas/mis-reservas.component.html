<div class="navigation-header">
  <button (click)="irAInicio()" class="btn-home-nav">
    üè† Inicio
  </button>
  <button (click)="irABuscar()" class="btn-search-nav">
    üîç Buscar Habitaciones
  </button>
</div>

<div class="mis-reservas-container">

  <!-- Header -->
  <div class="header">
    <h1>üìã Mis Reservas</h1>
    <button class="btn-recargar" (click)="recargar()" [disabled]="cargando">
      üîÑ {{ cargando ? 'Cargando...' : 'Actualizar' }}
    </button>
  </div>

  <!-- Filtros y B√∫squeda -->
  <div class="filtros-section">
    <!-- Filtros por Estado -->
    <div class="filtros-estado">
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'todas'"
        (click)="cambiarFiltro('todas')">
        Todas ({{ contarPorEstado('todas') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'confirmada'"
        (click)="cambiarFiltro('confirmada')">
        ‚úÖ Confirmadas ({{ contarPorEstado('confirmada') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'pendiente'"
        (click)="cambiarFiltro('pendiente')">
        ‚è≥ Pendientes ({{ contarPorEstado('pendiente') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'cancelada'"
        (click)="cambiarFiltro('cancelada')">
        ‚ùå Canceladas ({{ contarPorEstado('cancelada') }})
      </button>
      <button 
        class="filtro-btn" 
        [class.activo]="estadoFiltro === 'completada'"
        (click)="cambiarFiltro('completada')">
        ‚úîÔ∏è Completadas ({{ contarPorEstado('completada') }})
      </button>
    </div>

    <!-- Barra de B√∫squeda -->
    <div class="busqueda">
      <input 
        type="text" 
        class="input-busqueda" 
        placeholder="Buscar por c√≥digo, hotel o tipo de habitaci√≥n..."
        [(ngModel)]="busquedaCodigo"
        (input)="buscar()">
      <button 
        class="btn-limpiar" 
        *ngIf="busquedaCodigo"
        (click)="limpiarBusqueda()">
        ‚úï
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando" class="loading">
    <div class="spinner"></div>
    <p>Cargando reservas...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !cargando" class="error-message">
    <p>‚ö†Ô∏è {{ error }}</p>
    <button class="btn-reintentar" (click)="recargar()">Reintentar</button>
  </div>

  <!-- Lista Vac√≠a -->
  <div *ngIf="!cargando && !error && reservasFiltradas.length === 0" class="lista-vacia">
    <div class="icono-vacio">üì≠</div>
    <h3>No hay reservas</h3>
    <p *ngIf="busquedaCodigo">No se encontraron resultados para "{{ busquedaCodigo }}"</p>
    <p *ngIf="!busquedaCodigo && estadoFiltro !== 'todas'">
      No tienes reservas en estado "{{ estadoFiltro }}"
    </p>
    <p *ngIf="!busquedaCodigo && estadoFiltro === 'todas'">
      A√∫n no has realizado ninguna reserva o no se encontraron reservas recientes.
    </p>
    <div class="info-filtro">
      <small>üí° Se muestran solo las reservas m√°s recientes con datos completos</small>
    </div>
    <button class="btn-buscar-habitaciones" (click)="irABuscar()">
      üîç Buscar Habitaciones
    </button>
  </div>

  <!-- Lista de Reservas -->
  <div *ngIf="!cargando && !error && reservasFiltradas.length > 0" class="reservas-grid">
    <div *ngFor="let reserva of reservasFiltradas" class="reserva-card">
      <!-- Header de Card -->
      <div class="card-header">
        <div class="codigo-estado">
          <span class="codigo">{{ reserva.codigoReserva }}</span>
          <span class="estado-badge" [ngClass]="getEstadoClase(reserva.estado)">
            {{ getEstadoIcono(reserva.estado) }} {{ reserva.estado }}
          </span>
        </div>
        <div class="tiempo-restante" *ngIf="reserva.estado === 'confirmada' && reserva.horasHastaCheckIn && reserva.horasHastaCheckIn > 0">
          ‚è∞ {{ getTiempoRestante(reserva) }}
        </div>
      </div>

      <!-- Informaci√≥n Principal -->
      <div class="card-body">
        <!-- Hotel y Habitaci√≥n -->
        <div class="info-principal">
          <h3 class="hotel-nombre">üè® {{ reserva.hotel.nombre }}</h3>
          <p class="hotel-ubicacion">üìç {{ reserva.hotel.ciudad }}, {{ reserva.hotel.departamento }}</p>
          <p class="habitacion-tipo">üõèÔ∏è {{ reserva.habitacion.tipo }} - Habitaci√≥n {{ reserva.habitacion.numero }}</p>
        </div>

        <!-- Fechas -->
        <div class="info-fechas">
          <div class="fecha-item">
            <span class="fecha-label">Check-in:</span>
            <span class="fecha-valor">{{ formatearFecha(reserva.fechaInicio) }}</span>
          </div>
          <div class="fecha-item">
            <span class="fecha-label">Check-out:</span>
            <span class="fecha-valor">{{ formatearFecha(reserva.fechaFin) }}</span>
          </div>
          <div class="fecha-item">
            <span class="fecha-label">Noches:</span>
            <span class="fecha-valor">{{ reserva.noches }}</span>
          </div>
        </div>

        <!-- Tarifa -->
        <div class="info-tarifa">
          <div class="tarifa-total">
            <span class="tarifa-label">Total:</span>
            <span class="tarifa-valor">{{ formatearPrecio(reserva.tarifa.total) }}</span>
          </div>
        </div>

        <!-- Alertas de Acci√≥n -->
        <div class="alertas" *ngIf="reserva.estado === 'confirmada'">
          <!-- Alerta: No puede modificar (< 24h) -->
          <div class="alerta alerta-warning" *ngIf="!reserva.puedeModificar && reserva.horasHastaCheckIn && reserva.horasHastaCheckIn < 24 && reserva.horasHastaCheckIn > 0">
            ‚ö†Ô∏è No puedes modificar esta reserva (faltan menos de 24h para el check-in)
          </div>

          <!-- Alerta: Puede modificar -->
          <div class="alerta alerta-info" *ngIf="reserva.puedeModificar">
            ‚ÑπÔ∏è Puedes modificar las fechas hasta 24h antes del check-in
          </div>
        </div>
      </div>

      <!-- Footer de Card: Botones de Acci√≥n -->
      <div class="card-footer">
        <!-- HU11: Bot√≥n Descargar Recibo -->
        <button 
          class="btn btn-recibo" 
          *ngIf="reserva.estado === 'confirmada' || reserva.estado === 'completada'"
          (click)="verRecibo(reserva)"
          title="Ver y descargar recibo de pago">
          üìÑ Ver Recibo
        </button>

        <button class="btn btn-secondary" (click)="verDetalle(reserva)">
          üëÅÔ∏è Ver Detalle
        </button>

        <!-- HU09: Bot√≥n Modificar Fechas -->
        <button 
          class="btn btn-primary" 
          *ngIf="reserva.estado === 'confirmada'"
          [disabled]="!reserva.puedeModificar"
          [title]="!reserva.puedeModificar ? 'No se puede modificar esta reserva' : 'Modificar fechas de la reserva'"
          (click)="modificarFechas(reserva)">
          üìÖ Modificar
        </button>

        <!-- HU10: Bot√≥n Cancelar -->
        <button 
          class="btn btn-danger" 
          *ngIf="reserva.estado === 'confirmada'"
          [disabled]="!reserva.puedeCancelar"
          [title]="!reserva.puedeCancelar ? 'No se puede cancelar esta reserva' : 'Cancelar reserva'"
          (click)="abrirModalCancelar(reserva)">
          ‚ùå Cancelar
        </button>

        <!-- Estado no permite acciones -->
        <span class="sin-acciones" *ngIf="reserva.estado !== 'confirmada' && reserva.estado !== 'completada'">
          {{ reserva.estado === 'cancelada' ? 'Reserva cancelada' : 'Reserva en proceso' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Modal de Cancelaci√≥n -->
  <div class="modal-overlay" *ngIf="mostrarModalCancelar" (click)="cerrarModalCancelar()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üö´ Cancelar Reserva</h2>
        <button class="btn-cerrar-modal" (click)="cerrarModalCancelar()">‚úï</button>
      </div>

      <div class="modal-body">
        <!-- HU10: Loading mientras verifica pol√≠ticas -->
        <div *ngIf="verificandoPoliticas" class="modal-loading">
          <div class="spinner-small"></div>
          <p>Verificando pol√≠ticas de cancelaci√≥n...</p>
        </div>

        <!-- Contenido del modal cuando ya se verificaron pol√≠ticas -->
        <div *ngIf="!verificandoPoliticas && politicaCancelacion">
          <p class="modal-advertencia">
            ‚ö†Ô∏è Est√°s a punto de cancelar la siguiente reserva:
          </p>

          <div class="reserva-resumen" *ngIf="reservaACancelar">
            <p><strong>C√≥digo:</strong> {{ reservaACancelar.codigoReserva }}</p>
            <p><strong>Hotel:</strong> {{ reservaACancelar.hotel.nombre }}</p>
            <p><strong>Habitaci√≥n:</strong> {{ reservaACancelar.habitacion.tipo }}</p>
            <p><strong>Fechas:</strong> {{ formatearFecha(reservaACancelar.fechaInicio) }} - {{ formatearFecha(reservaACancelar.fechaFin) }}</p>
            <p><strong>Total pagado:</strong> {{ formatearPrecio(reservaACancelar.tarifa.total) }}</p>
          </div>

          <!-- HU10 CA1 + CA2: Informaci√≥n de Penalizaci√≥n -->
          <div class="politica-cancelacion">
            <h4>üìã Pol√≠tica de Cancelaci√≥n</h4>
            
            <!-- CA1: Cancelaci√≥n Gratuita -->
            <div *ngIf="politicaCancelacion.dentroVentanaGratuita" class="alerta alerta-success">
              <strong>‚úÖ Cancelaci√≥n Gratuita</strong>
              <p>{{ politicaCancelacion.mensaje }}</p>
              <div class="detalle-reembolso">
                <span>Reembolso completo:</span>
                <strong class="monto-reembolso">{{ formatearPrecio(politicaCancelacion.montoReembolso) }}</strong>
              </div>
            </div>

            <!-- CA2: Con Penalizaci√≥n -->
            <div *ngIf="!politicaCancelacion.dentroVentanaGratuita" class="alerta alerta-warning-penalizacion">
              <strong>‚ö†Ô∏è Penalizaci√≥n Aplicable</strong>
              <p>{{ politicaCancelacion.mensaje }}</p>
              
              <div class="desglose-penalizacion">
                <div class="linea-desglose">
                  <span>Total pagado:</span>
                  <span>{{ formatearPrecio(reservaACancelar?.tarifa?.total || 0) }}</span>
                </div>
                <div class="linea-desglose penalizacion">
                  <span>Penalizaci√≥n ({{ politicaCancelacion.porcentajePenalizacion }}%):</span>
                  <span class="monto-negativo">-{{ formatearPrecio(politicaCancelacion.montoPenalizacion) }}</span>
                </div>
                <div class="linea-desglose total-reembolso">
                  <span><strong>Reembolso:</strong></span>
                  <strong class="monto-reembolso">{{ formatearPrecio(politicaCancelacion.montoReembolso) }}</strong>
                </div>
              </div>

              <!-- CA2: Checkbox de confirmaci√≥n de penalizaci√≥n -->
              <div class="confirmacion-penalizacion">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    [(ngModel)]="aceptaPenalizacion"
                    [disabled]="cancelando">
                  <span>Acepto la penalizaci√≥n del {{ politicaCancelacion.porcentajePenalizacion }}% y entiendo que recibir√© {{ formatearPrecio(politicaCancelacion.montoReembolso) }} de reembolso.</span>
                </label>
              </div>
            </div>

            <!-- Informaci√≥n adicional -->
            <div class="info-tiempo">
              <p><strong>‚è∞ Tiempo hasta check-in:</strong> {{ politicaCancelacion.horasHastaCheckIn }} horas ({{ politicaCancelacion.diasHastaCheckIn }} d√≠as)</p>
            </div>

            <div class="detalles-politica">
              <p class="titulo-detalles"><strong>Ventanas de cancelaci√≥n:</strong></p>
              <ul>
                <li>{{ politicaCancelacion.detalles.ventanaGratuita }}: Sin penalizaci√≥n</li>
                <li>{{ politicaCancelacion.detalles.penalizacion50 }}: 50% de penalizaci√≥n</li>
                <li>{{ politicaCancelacion.detalles.penalizacion100 }}: 100% de penalizaci√≥n</li>
              </ul>
            </div>
          </div>

          <!-- Motivo de cancelaci√≥n -->
          <div class="form-group">
            <label for="motivoCancelacion">Motivo de la cancelaci√≥n: *</label>
            <textarea 
              id="motivoCancelacion"
              class="textarea-motivo"
              [(ngModel)]="motivoCancelacion"
              placeholder="Por favor, indica el motivo de la cancelaci√≥n..."
              rows="3"
              [disabled]="cancelando"></textarea>
          </div>

          <!-- HU10 CA4: Nota sobre notificaci√≥n -->
          <p class="modal-nota">
            ‚ÑπÔ∏è Recibir√°s un correo electr√≥nico de confirmaci√≥n con los detalles de la cancelaci√≥n.
          </p>
        </div>
      </div>

      <div class="modal-footer" *ngIf="!verificandoPoliticas">
        <button 
          class="btn btn-secondary" 
          (click)="cerrarModalCancelar()"
          [disabled]="cancelando">
          Volver
        </button>
        <button 
          class="btn btn-danger" 
          (click)="confirmarCancelacion()"
          [disabled]="cancelando || !motivoCancelacion.trim() || (politicaCancelacion && politicaCancelacion.montoPenalizacion > 0 && !aceptaPenalizacion)">
          {{ cancelando ? 'Cancelando...' : 'Confirmar Cancelaci√≥n' }}
        </button>
      </div>
    </div>
  </div>
</div>
