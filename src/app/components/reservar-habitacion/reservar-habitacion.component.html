<div class="navigation-header">
  <button (click)="volverADetalle()" class="btn-volver-nav">
    ‚Üê Volver al Detalle
  </button>
  <button (click)="irAInicio()" class="btn-home-nav">
    üè† Inicio
  </button>
</div>

<div class="reservar-container">
  <!-- Loading -->
  <div *ngIf="cargando" class="loading">
    <div class="spinner"></div>
    <p>Cargando informaci√≥n...</p>
  </div>

  <!-- Error inicial (sin fechas) -->
  <div *ngIf="error && !habitacion" class="error-inicial">
    <h2>‚ö†Ô∏è Error</h2>
    <p>{{ error }}</p>
    <button (click)="volverABusqueda()" class="btn-primary">Volver a la b√∫squeda</button>
  </div>

  <!-- PASO 1: RESUMEN -->
  <div *ngIf="pasoActual === 'resumen' && habitacion && tarifa" class="paso-resumen">
    <div class="progreso">
      <span class="paso activo">1. Resumen</span>
      <span class="paso">2. Datos</span>
      <span class="paso">3. Confirmaci√≥n</span>
    </div>

    <h1>Reserva de Habitaci√≥n</h1>

    <div class="resumen-habitacion">
      <img [src]="habitacion.fotos && habitacion.fotos.length > 0 ? habitacion.fotos[0] : '/assets/habitacion-default.jpg'" 
           [alt]="habitacion.tipo" class="foto-habitacion">
      <div class="info-habitacion">
        <h2>{{ habitacion.tipo }} - {{ habitacion.numero }}</h2>
        <p class="hotel-info">üè® {{ habitacion.hotel.nombre }} - {{ habitacion.hotel.ciudad }}</p>
        <p>üë• {{ huespedes }} hu√©sped{{ huespedes > 1 ? 'es' : '' }}</p>
      </div>
    </div>

    <div class="resumen-fechas">
      <h3>üìÖ Fechas</h3>
      <div class="fechas-grid">
        <div>
          <strong>Check-in:</strong>
          <p>{{ fechaInicio | date:'d MMM yyyy' }}</p>
        </div>
        <div>
          <strong>Check-out:</strong>
          <p>{{ fechaFin | date:'d MMM yyyy' }}</p>
        </div>
        <div>
          <strong>Noches:</strong>
          <p>{{ noches }}</p>
        </div>
      </div>
    </div>

    <div class="desglose-tarifa">
      <h3>üí∞ Desglose de Precio</h3>
      <div class="linea-precio">
        <span>{{ formatearPrecio(tarifa.precioPorNoche) }} √ó {{ noches }} noches</span>
        <span>{{ formatearPrecio(tarifa.subtotal) }}</span>
      </div>
      <div class="linea-precio">
        <span>IVA (19%)</span>
        <span>{{ formatearPrecio(tarifa.impuestos.monto) }}</span>
      </div>
      <hr>
      <div class="linea-precio total">
        <span><strong>TOTAL</strong></span>
        <span><strong>{{ formatearPrecio(tarifa.total) }} COP</strong></span>
      </div>
    </div>

    <div class="botones">
      <button (click)="verDetalle()" class="btn-secondary">‚Üê Volver al detalle</button>
      <button (click)="irADatos()" class="btn-primary">Continuar con la reserva ‚Üí</button>
    </div>
  </div>

  <!-- PASO 2: DATOS -->
  <div *ngIf="pasoActual === 'datos' && datosForm" class="paso-datos">
    <div class="progreso">
      <span class="paso completado">‚úì Resumen</span>
      <span class="paso activo">2. Datos</span>
      <span class="paso">3. Confirmaci√≥n</span>
    </div>

    <h2>Datos del Hu√©sped</h2>
    <p class="subtitulo">Completa tus datos para continuar con la reserva</p>

    <form [formGroup]="datosForm" class="formulario-datos">
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombre *</label>
          <input 
            type="text" 
            id="nombre" 
            formControlName="nombre" 
            placeholder="Ej: Juan"
            [class.error]="mostrarError('nombre')">
          <span *ngIf="mostrarError('nombre')" class="mensaje-error">
            {{ obtenerErrorCampo('nombre') }}
          </span>
        </div>

        <div class="form-group">
          <label for="apellido">Apellido *</label>
          <input 
            type="text" 
            id="apellido" 
            formControlName="apellido" 
            placeholder="Ej: P√©rez"
            [class.error]="mostrarError('apellido')">
          <span *ngIf="mostrarError('apellido')" class="mensaje-error">
            {{ obtenerErrorCampo('apellido') }}
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="email">Correo Electr√≥nico *</label>
          <input 
            type="email" 
            id="email" 
            formControlName="email" 
            placeholder="ejemplo@correo.com"
            [class.error]="mostrarError('email')">
          <span *ngIf="mostrarError('email')" class="mensaje-error">
            {{ obtenerErrorCampo('email') }}
          </span>
        </div>

        <div class="form-group">
          <label for="telefono">Tel√©fono *</label>
          <input 
            type="tel" 
            id="telefono" 
            formControlName="telefono" 
            placeholder="+57 300 123 4567"
            [class.error]="mostrarError('telefono')">
          <span *ngIf="mostrarError('telefono')" class="mensaje-error">
            {{ obtenerErrorCampo('telefono') }}
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="documento">Documento</label>
          <input 
            type="text" 
            id="documento" 
            formControlName="documento" 
            placeholder="Opcional">
        </div>

        <div class="form-group">
          <label for="pais">Pa√≠s</label>
          <select id="pais" formControlName="pais">
            <option value="Colombia">Colombia</option>
            <option value="Argentina">Argentina</option>
            <option value="M√©xico">M√©xico</option>
            <option value="Espa√±a">Espa√±a</option>
            <option value="Estados Unidos">Estados Unidos</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="ciudad">Ciudad</label>
        <input 
          type="text" 
          id="ciudad" 
          formControlName="ciudad" 
          placeholder="Opcional">
      </div>

      <div class="form-group">
        <label for="notas">Notas / Solicitudes especiales</label>
        <textarea 
          id="notas" 
          formControlName="notas" 
          rows="4"
          placeholder="Ej: Necesito cuna para beb√©, cama extra, etc."></textarea>
      </div>
    </form>

    <div class="botones">
      <button (click)="volverPaso()" class="btn-secondary">‚Üê Atr√°s</button>
      <button (click)="irAConfirmacion()" [disabled]="datosForm.invalid" class="btn-primary">
        Continuar a confirmaci√≥n ‚Üí
      </button>
    </div>
  </div>

  <!-- PASO 3: CONFIRMACI√ìN -->
  <div *ngIf="pasoActual === 'confirmacion' && habitacion && tarifa" class="paso-confirmacion">
    <div class="progreso">
      <span class="paso completado">‚úì Resumen</span>
      <span class="paso completado">‚úì Datos</span>
      <span class="paso activo">3. Confirmaci√≥n</span>
    </div>

    <h2>Confirmaci√≥n de Reserva</h2>

    <div class="resumen-final">
      <div class="card">
        <h3>‚úÖ Resumen</h3>
        <p><strong>Habitaci√≥n:</strong> {{ habitacion.tipo }} {{ habitacion.numero }}</p>
        <p><strong>Hotel:</strong> {{ habitacion.hotel.nombre }}</p>
        <p><strong>Fechas:</strong> {{ fechaInicio | date:'d MMM' }} - {{ fechaFin | date:'d MMM yyyy' }} ({{ noches }} noches)</p>
        <p><strong>Hu√©spedes:</strong> {{ huespedes }}</p>
        <p class="precio-total"><strong>Total:</strong> {{ formatearPrecio(tarifa.total) }} COP</p>
      </div>

      <div class="card">
        <h3>üë§ Hu√©sped</h3>
        <p><strong>Nombre:</strong> {{ datosForm.value.nombre }} {{ datosForm.value.apellido }}</p>
        <p><strong>Correo:</strong> {{ datosForm.value.email }}</p>
        <p><strong>Tel√©fono:</strong> {{ datosForm.value.telefono }}</p>
        <p *ngIf="datosForm.value.pais"><strong>Pa√≠s:</strong> {{ datosForm.value.pais }}</p>
      </div>
    </div>

    <div class="card-politicas">
      <h3>üìã Pol√≠ticas de Cancelaci√≥n</h3>
      <div class="politicas-contenido">
        <p><strong>Check-in:</strong> {{ habitacion.hotel.politicas.checkIn || '15:00' }}</p>
        <p><strong>Check-out:</strong> {{ habitacion.hotel.politicas.checkOut || '12:00' }}</p>
        <p *ngIf="habitacion.hotel.politicas.cancelacion"><strong>Cancelaci√≥n:</strong> {{ habitacion.hotel.politicas.cancelacion }}</p>
        <p><strong>Mascotas:</strong> {{ habitacion.hotel.politicas.mascotas ? 'Permitidas' : 'No permitidas' }}</p>
        <p><strong>Fumadores:</strong> {{ habitacion.hotel.politicas.fumadores ? 'Permitido' : 'No permitido' }}</p>
      </div>
      
      <label class="checkbox-politicas">
        <input 
          type="checkbox" 
          [checked]="politicasAceptadas"
          (change)="politicasAceptadas = !politicasAceptadas"
          [attr.data-testid]="'checkbox-politicas'">
        <span>He le√≠do y acepto las pol√≠ticas de cancelaci√≥n</span>
      </label>
    </div>

    <div class="botones">
      <button (click)="volverPaso()" class="btn-secondary">‚Üê Atr√°s</button>
      <button 
        (click)="confirmarReserva()" 
        [disabled]="!politicasAceptadas || procesando"
        [attr.data-testid]="'btn-confirmar-reserva'"
        class="btn-primary btn-confirmar">
        {{ procesando ? 'Procesando...' : 'Confirmar Reserva' }}
      </button>
    </div>
  </div>

  <!-- PASO 4: √âXITO -->
  <div *ngIf="pasoActual === 'exito' && reservaCreada" class="paso-exito">
    <div class="icono-exito">‚úÖ</div>
    <h1>¬°Reserva Confirmada!</h1>
    
    <div class="codigo-reserva">
      <p class="label-codigo">Tu c√≥digo de reserva es:</p>
      <div class="codigo">{{ reservaCreada.codigoReserva }}</div>
      <p class="info-codigo">Guarda este c√≥digo para futuras consultas</p>
    </div>

    <div class="confirmacion-email">
      <p>üìß Se ha enviado la confirmaci√≥n a: <strong>{{ reservaCreada.datosHuesped.email }}</strong></p>
    </div>

    <div class="resumen-reserva">
      <h3>Detalles de tu Reserva</h3>
      <div class="detalle-linea">
        <span>üè® Hotel:</span>
        <span>{{ reservaCreada.hotel.nombre }}</span>
      </div>
      <div class="detalle-linea">
        <span>üõèÔ∏è Habitaci√≥n:</span>
        <span>{{ reservaCreada.habitacion.tipo }} {{ reservaCreada.habitacion.numero }}</span>
      </div>
      <div class="detalle-linea">
        <span>üìÖ Fechas:</span>
        <span>{{ reservaCreada.fechaInicio | date:'d MMM' }} - {{ reservaCreada.fechaFin | date:'d MMM yyyy' }}</span>
      </div>
      <div class="detalle-linea">
        <span>üåô Noches:</span>
        <span>{{ reservaCreada.noches }}</span>
      </div>
      <div class="detalle-linea total">
        <span>üí∞ Total:</span>
        <span><strong>{{ formatearPrecio(reservaCreada.tarifa.total) }} COP</strong></span>
      </div>
      <div class="detalle-linea">
        <span>üë§ Hu√©sped:</span>
        <span>{{ reservaCreada.datosHuesped.nombre }} {{ reservaCreada.datosHuesped.apellido }}</span>
      </div>
    </div>

    <div class="botones-exito">
      <button (click)="volverABusqueda()" class="btn-secondary">‚Üê Volver al inicio</button>
      <button (click)="verMiReserva()" class="btn-primary">Ver detalle completo</button>
    </div>
  </div>

  <!-- PANTALLA DE ERROR (CA3: Conflicto) -->
  <div *ngIf="pasoActual === 'error'" class="paso-error">
    <div class="icono-error">‚ö†Ô∏è</div>
    <h1>Lo Sentimos</h1>
    
    <div class="mensaje-error-principal">
      <p *ngIf="conflictoDisponibilidad">
        La habitaci√≥n ya no est√° disponible para las fechas seleccionadas.
      </p>
      <p *ngIf="!conflictoDisponibilidad && error">
        {{ error }}
      </p>
      <p *ngIf="!error">
        Ha ocurrido un error al procesar tu reserva. Por favor, intenta nuevamente.
      </p>
    </div>

    <div *ngIf="conflictoDisponibilidad" class="sugerencias">
      <h3>üí° Te recomendamos:</h3>
      <ul>
        <li>Volver a la b√∫squeda</li>
        <li>Seleccionar otras fechas</li>
        <li>Elegir otra habitaci√≥n similar</li>
      </ul>
    </div>

    <div class="botones-error">
      <button 
        (click)="verDetalle()" 
        class="btn-secondary">
        ‚Üê Volver al detalle
      </button>
      <button 
        (click)="volverABusqueda()" 
        [attr.data-testid]="'btn-volver-busqueda'"
        class="btn-primary">
        üîç Volver a la b√∫squeda
      </button>
    </div>
  </div>
</div>
