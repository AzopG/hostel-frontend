<div class="navigation-header">
  <button (click)="volverADetalle()" class="btn-volver-nav">
    â† Volver al Detalle
  </button>
  <button (click)="irAInicio()" class="btn-home-nav">
    ğŸ  Inicio
  </button>
</div>

<div class="reservar-container">
  <!-- Loading -->
  <div *ngIf="cargando" class="loading">
    <div class="spinner"></div>
    <p>Cargando informaciÃ³n...</p>
  </div>

  <!-- Error inicial (sin fechas) -->
  <div *ngIf="error && !habitacion" class="error-inicial">
    <h2>âš ï¸ Error</h2>
    <p>{{ error }}</p>
    <button (click)="volverABusqueda()" class="btn-primary">Volver a la bÃºsqueda</button>
  </div>

  <!-- PASO 1: RESUMEN -->
  <div *ngIf="pasoActual === 'resumen' && habitacion && tarifa" class="paso-resumen">
    <div class="progreso">
      <span class="paso activo">1. Resumen</span>
      <span class="paso">2. Datos</span>
      <span class="paso">3. ConfirmaciÃ³n</span>
    </div>

    <h1>Reserva de HabitaciÃ³n</h1>

    <div class="resumen-habitacion">
      <img [src]="habitacion.fotos && habitacion.fotos.length > 0 ? habitacion.fotos[0] : '/assets/habitacion-default.jpg'" 
           [alt]="habitacion.tipo" class="foto-habitacion">
      <div class="info-habitacion">
        <h2>{{ habitacion.tipo }} - {{ habitacion.numero }}</h2>
        <p class="hotel-info">ğŸ¨ {{ habitacion.hotel.nombre }} - {{ habitacion.hotel.ciudad }}</p>
        <p>ğŸ‘¥ {{ huespedes }} huÃ©sped{{ huespedes > 1 ? 'es' : '' }}</p>
      </div>
    </div>

    <div class="resumen-fechas">
      <h3>ğŸ“… Fechas</h3>
      <div class="fechas-grid">
        <div>
          <strong>Check-in:</strong>
          <p>{{ fechaInicio | date:'d MMM yyyy' }}</p>
        </div>
        <div>
          <strong>Check-out:</strong>
          <p>{{ fechaFin | date:'d MMM yyyy' }}</p>
        </div>
        <div>
          <strong>Noches:</strong>
          <p>{{ noches }}</p>
        </div>
      </div>
    </div>

    <div class="desglose-tarifa">
      <h3>ğŸ’° Desglose de Precio</h3>
      <div class="linea-precio">
        <span>{{ formatearPrecio(tarifa.precioPorNoche) }} Ã— {{ noches }} noches</span>
        <span>{{ formatearPrecio(tarifa.subtotal) }}</span>
      </div>
      <div class="linea-precio">
        <span>IVA (19%)</span>
        <span>{{ formatearPrecio(tarifa.impuestos.monto) }}</span>
      </div>
      <hr>
      <div class="linea-precio total">
        <span><strong>TOTAL</strong></span>
        <span><strong>{{ formatearPrecio(tarifa.total) }} COP</strong></span>
      </div>
    </div>

    <div class="botones">
      <button (click)="verDetalle()" class="btn-secondary">â† Volver al detalle</button>
      <button (click)="irADatos()" class="btn-primary">Continuar con la reserva â†’</button>
    </div>
  </div>

  <!-- PASO 2: DATOS -->
  <div *ngIf="pasoActual === 'datos' && datosForm" class="paso-datos">
    <div class="progreso">
      <span class="paso completado">âœ“ Resumen</span>
      <span class="paso activo">2. Datos</span>
      <span class="paso">3. ConfirmaciÃ³n</span>
    </div>

    <h2>Datos del HuÃ©sped</h2>
    <p class="subtitulo">Completa tus datos para continuar con la reserva</p>

    <form [formGroup]="datosForm" class="formulario-datos">
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombre *</label>
          <input 
            type="text" 
            id="nombre" 
            formControlName="nombre" 
            placeholder="Ej: Juan"
            [class.error]="mostrarError('nombre')">
          <span *ngIf="mostrarError('nombre')" class="mensaje-error">
            {{ obtenerErrorCampo('nombre') }}
          </span>
        </div>

        <div class="form-group">
          <label for="apellido">Apellido *</label>
          <input 
            type="text" 
            id="apellido" 
            formControlName="apellido" 
            placeholder="Ej: PÃ©rez"
            [class.error]="mostrarError('apellido')">
          <span *ngIf="mostrarError('apellido')" class="mensaje-error">
            {{ obtenerErrorCampo('apellido') }}
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="email">Correo ElectrÃ³nico *</label>
          <input 
            type="email" 
            id="email" 
            formControlName="email" 
            placeholder="ejemplo@correo.com"
            [class.error]="mostrarError('email')">
          <span *ngIf="mostrarError('email')" class="mensaje-error">
            {{ obtenerErrorCampo('email') }}
          </span>
        </div>

        <div class="form-group">
          <label for="telefono">TelÃ©fono *</label>
          <input 
            type="tel" 
            id="telefono" 
            formControlName="telefono" 
            placeholder="+57 300 123 4567"
            [class.error]="mostrarError('telefono')">
          <span *ngIf="mostrarError('telefono')" class="mensaje-error">
            {{ obtenerErrorCampo('telefono') }}
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="documento">Documento</label>
          <input 
            type="text" 
            id="documento" 
            formControlName="documento" 
            placeholder="Opcional">
        </div>

        <div class="form-group">
          <label for="pais">PaÃ­s</label>
          <select id="pais" formControlName="pais">
            <option value="Colombia">Colombia</option>
            <option value="Argentina">Argentina</option>
            <option value="MÃ©xico">MÃ©xico</option>
            <option value="EspaÃ±a">EspaÃ±a</option>
            <option value="Estados Unidos">Estados Unidos</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="ciudad">Ciudad</label>
        <input 
          type="text" 
          id="ciudad" 
          formControlName="ciudad" 
          placeholder="Opcional">
      </div>

      <div class="form-group">
        <label for="notas">Notas / Solicitudes especiales</label>
        <textarea 
          id="notas" 
          formControlName="notas" 
          rows="4"
          placeholder="Ej: Necesito cuna para bebÃ©, cama extra, etc."></textarea>
      </div>
    </form>

    <div class="botones">
      <button (click)="volverPaso()" class="btn-secondary">â† AtrÃ¡s</button>
      <button (click)="irAConfirmacion()" [disabled]="datosForm.invalid" class="btn-primary">
        Continuar a confirmaciÃ³n â†’
      </button>
    </div>
  </div>

  <!-- PASO 3: CONFIRMACIÃ“N -->
  <div *ngIf="pasoActual === 'confirmacion' && habitacion && tarifa" class="paso-confirmacion">
    <div class="progreso">
      <span class="paso completado">âœ“ Resumen</span>
      <span class="paso completado">âœ“ Datos</span>
      <span class="paso activo">3. ConfirmaciÃ³n</span>
    </div>

    <h2>ConfirmaciÃ³n de Reserva</h2>

    <div class="resumen-final">
      <div class="card">
        <h3>âœ… Resumen</h3>
        <p><strong>HabitaciÃ³n:</strong> {{ habitacion.tipo }} {{ habitacion.numero }}</p>
        <p><strong>Hotel:</strong> {{ habitacion.hotel.nombre }}</p>
        <p><strong>Fechas:</strong> {{ fechaInicio | date:'d MMM' }} - {{ fechaFin | date:'d MMM yyyy' }} ({{ noches }} noches)</p>
        <p><strong>HuÃ©spedes:</strong> {{ huespedes }}</p>
        <p class="precio-total"><strong>Total:</strong> {{ formatearPrecio(tarifa.total) }} COP</p>
      </div>

      <div class="card">
        <h3>ğŸ‘¤ HuÃ©sped</h3>
        <p><strong>Nombre:</strong> {{ datosForm.value.nombre }} {{ datosForm.value.apellido }}</p>
        <p><strong>Correo:</strong> {{ datosForm.value.email }}</p>
        <p><strong>TelÃ©fono:</strong> {{ datosForm.value.telefono }}</p>
        <p *ngIf="datosForm.value.pais"><strong>PaÃ­s:</strong> {{ datosForm.value.pais }}</p>
      </div>
    </div>

    <div class="card-politicas">
      <h3>ğŸ“‹ PolÃ­ticas de CancelaciÃ³n</h3>
      <div class="politicas-contenido">
        <p><strong>Check-in:</strong> {{ habitacion.hotel.politicas.checkIn || '15:00' }}</p>
        <p><strong>Check-out:</strong> {{ habitacion.hotel.politicas.checkOut || '12:00' }}</p>
        <p *ngIf="habitacion.hotel.politicas.cancelacion"><strong>CancelaciÃ³n:</strong> {{ habitacion.hotel.politicas.cancelacion }}</p>
        <p><strong>Mascotas:</strong> {{ habitacion.hotel.politicas.mascotas ? 'Permitidas' : 'No permitidas' }}</p>
        <p><strong>Fumadores:</strong> {{ habitacion.hotel.politicas.fumadores ? 'Permitido' : 'No permitido' }}</p>
      </div>
      
      <label class="checkbox-politicas">
        <input 
          type="checkbox" 
          [checked]="politicasAceptadas"
          (change)="politicasAceptadas = !politicasAceptadas"
          [attr.data-testid]="'checkbox-politicas'">
        <span>He leÃ­do y acepto las polÃ­ticas de cancelaciÃ³n</span>
      </label>
    </div>

    <div class="botones">
      <button (click)="volverPaso()" class="btn-secondary">â† AtrÃ¡s</button>
      <button 
        (click)="confirmarReserva()" 
        [disabled]="!politicasAceptadas || procesando"
        [attr.data-testid]="'btn-confirmar-reserva'"
        class="btn-primary btn-confirmar">
        {{ procesando ? 'Procesando...' : 'Confirmar Reserva' }}
      </button>
    </div>
  </div>

  <!-- PASO 4: Ã‰XITO -->
  <div *ngIf="pasoActual === 'exito' && reservaCreada" class="paso-exito">
    <div class="icono-exito">âœ…</div>
    <h1>Â¡Reserva Confirmada!</h1>
    
    <div class="codigo-reserva">
      <p class="label-codigo">Tu cÃ³digo de reserva es:</p>
      <div class="codigo">{{ reservaCreada.codigoReserva }}</div>
      <p class="info-codigo">Guarda este cÃ³digo para futuras consultas</p>
    </div>

    <div class="confirmacion-email">
      <p>ğŸ“§ Se ha enviado la confirmaciÃ³n a: <strong>{{ reservaCreada.datosHuesped.email }}</strong></p>
    </div>

    <div class="resumen-reserva">
      <h3>Detalles de tu Reserva</h3>
      <div class="detalle-linea">
        <span>ğŸ¨ Hotel:</span>
        <span>{{ reservaCreada.hotel.nombre }}</span>
      </div>
      <div class="detalle-linea">
        <span>ğŸ›ï¸ HabitaciÃ³n:</span>
        <span>{{ reservaCreada.habitacion.tipo }} {{ reservaCreada.habitacion.numero }}</span>
      </div>
      <div class="detalle-linea">
        <span>ğŸ“… Fechas:</span>
        <span>{{ reservaCreada.fechaInicio | date:'d MMM' }} - {{ reservaCreada.fechaFin | date:'d MMM yyyy' }}</span>
      </div>
      <div class="detalle-linea">
        <span>ğŸŒ™ Noches:</span>
        <span>{{ reservaCreada.noches }}</span>
      </div>
      <div class="detalle-linea total">
        <span>ğŸ’° Total:</span>
        <span><strong>{{ formatearPrecio(reservaCreada.tarifa.total) }} COP</strong></span>
      </div>
      <div class="detalle-linea">
        <span>ğŸ‘¤ HuÃ©sped:</span>
        <span>{{ reservaCreada.datosHuesped.nombre }} {{ reservaCreada.datosHuesped.apellido }}</span>
      </div>
    </div>

    <div class="botones-exito">
      <button (click)="volverABusqueda()" class="btn-secondary">â† Volver al inicio</button>
      <button (click)="verMiReserva()" class="btn-primary">Ver detalle completo</button>
    </div>
  </div>

  <!-- PANTALLA DE ERROR (CA3: Conflicto) -->
  <div *ngIf="pasoActual === 'error'" class="paso-error">
    <div class="icono-error">âš ï¸</div>
    <h1>Lo Sentimos</h1>
    
    <div class="mensaje-error-principal">
      <p *ngIf="conflictoDisponibilidad">
        La habitaciÃ³n ya no estÃ¡ disponible para las fechas seleccionadas.
      </p>
      <p *ngIf="!conflictoDisponibilidad && error">
        {{ error }}
      </p>
      <p *ngIf="!error">
        Ha ocurrido un error al procesar tu reserva. Por favor, intenta nuevamente.
      </p>
    </div>

    <div *ngIf="conflictoDisponibilidad" class="sugerencias">
      <h3>ğŸ’¡ Te recomendamos:</h3>
      <ul>
        <li>Volver a la bÃºsqueda</li>
        <li>Seleccionar otras fechas</li>
        <li>Elegir otra habitaciÃ³n similar</li>
      </ul>
    </div>

    <div class="botones-error">
      <button 
        (click)="verDetalle()" 
        class="btn-secondary">
        â† Volver al detalle
      </button>
      <button 
        (click)="volverABusqueda()" 
        [attr.data-testid]="'btn-volver-busqueda'"
        class="btn-primary">
        ğŸ” Volver a la bÃºsqueda
      </button>
    </div>
  </div>
</div>
